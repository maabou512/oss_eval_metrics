<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OSS Health Radar - CHAOSS Compliant</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f4f7f9; --card: #ffffff; --text: #334155; --chaoss: #002d4b; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .dashboard { display: grid; grid-template-columns: 320px 1fr; gap: 24px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--card); padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-ctrl { margin: 16px 0 24px; padding: 20px; background: #f8fafc; border-radius: 12px; text-align: center; }
        #year-slider { width: 100%; margin-top: 12px; cursor: pointer; }
        #current-year-display { font-size: 36px; font-weight: 800; color: var(--primary); }

        /* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ */
        .project-selector { margin-bottom: 10px; padding: 12px; border-radius: 10px; border: 1px solid #f1f5f9; display: flex; align-items: center; cursor: pointer; font-weight: 600; border-left: 6px solid #ccc; }
        .project-selector input { margin-right: 12px; width: 18px; height: 18px; }

        /* ãƒãƒ£ãƒ¼ãƒˆ */
        #chart-container { display: flex; flex-direction: column; align-items: center; }
        .tooltip {
            position: fixed; padding: 12px 16px; background: rgba(15, 23, 42, 0.95); color: #fff;
            border-radius: 8px; font-size: 13px; pointer-events: none; opacity: 0; z-index: 9999;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2); line-height: 1.6;
        }

        /* ğŸ›  æŒ‡æ¨™ã®å®šç¾© (CHAOSSæº–æ‹ ) */
        #explanation { width: 100%; margin-top: 32px; padding-top: 24px; border-top: 2px solid #f1f5f9; }
        .info-table { width: 100%; border-collapse: collapse; margin-top: 16px; background: #f8fafc; border-radius: 12px; overflow: hidden; }
        .info-table th, .info-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .info-table th { background: #f1f5f9; font-weight: 800; color: var(--chaoss); width: 220px; font-size: 14px; }
        .metric-ref { font-size: 11px; color: #64748b; display: block; margin-top: 4px; font-weight: normal; }
        .info-table b { color: var(--primary); }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒªãƒ³ã‚¯ */
        .footer-links { margin-top: 40px; text-align: center; padding: 20px; color: #94a3b8; font-size: 14px; }
        .footer-links a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .footer-links a:hover { text-decoration: underline; }

        .axis-label { font-size: 14px; font-weight: 800; fill: #475569; }
        .radar-area { fill-opacity: 0.15; stroke-width: 4; }
    </style>
</head>
<body>

<div class="dashboard">
    <div id="sidebar" class="card">
        <h3 style="margin-top:0">ğŸ“… Timeline</h3>
        <div class="timeline-ctrl">
            <span id="current-year-display">----</span>
            <input type="range" id="year-slider" step="1">
        </div>
        <h3 style="margin-bottom:16px">ğŸš€ Projects</h3>
        <div id="selectors"></div>
    </div>

    <div id="chart-container" class="card">
        <h2 style="margin: 0 0 10px 0; font-size: 26px;">OSS Health Radar Comparison</h2>
        <p style="margin: 0 0 20px 0; color: #64748b; font-size: 14px;">Powered by CHAOSS Metrics Framework</p>
        <div id="chart"></div>
        
        <div id="explanation">
            <h4 style="margin:0; color: var(--chaoss);">ğŸ“Š æŒ‡æ¨™ã®å®šç¾©ã¨CHAOSSãƒ¡ãƒˆãƒªã‚¯ã‚¹å¯¾å¿œ</h4>
            <table class="info-table">
                <tr>
                    <th>Activity<span class="metric-ref">CHAOSS: Code Changes / Commits</span></th>
                    <td><b>5,000 commitsã€œ</b>ï¼šé–‹ç™ºã®å›è»¢é€Ÿåº¦ã€‚ãƒªãƒã‚¸ãƒˆãƒªã¸ã®è²¢çŒ®é »åº¦ã‚’ç¤ºã—ã¾ã™ã€‚</td>
                </tr>
                <tr>
                    <th>Diversity<span class="metric-ref">CHAOSS: Organizational Diversity</span></th>
                    <td><b>15+ Orgs / Elephant 2+</b>ï¼šè²¢çŒ®è€…ã®æ‰€å±çµ„ç¹”æ•°ã€‚ç‰¹å®šä¼æ¥­ã¸ã®ä¾å­˜ãƒªã‚¹ã‚¯ã‚’è©•ä¾¡ã—ã¾ã™ã€‚</td>
                </tr>
                <tr>
                    <th>Density<span class="metric-ref">CHAOSS: Active Contributors</span></th>
                    <td><b>Activeç‡ 70%ã€œ</b>ï¼šå¹´é–“10å›ä»¥ä¸Šè²¢çŒ®ã™ã‚‹ã‚³ã‚¢ãƒ¡ãƒ³ãƒãƒ¼ã®æ¯”ç‡ã€‚å±¤ã®åšã•ã‚’ç¤ºã—ã¾ã™ã€‚</td>
                </tr>
                <tr>
                    <th>Responsiveness<span class="metric-ref">CHAOSS: Time to Close</span></th>
                    <td><b>å¹³å‡ 5æ—¥ä»¥å†…</b>ï¼šIssueã‚„PRãŒå‡¦ç†ã•ã‚Œã‚‹é€Ÿåº¦ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç¶­æŒç®¡ç†èƒ½åŠ›ã®æŒ‡æ¨™ã€‚</td>
                </tr>
                <tr>
                    <th>Robustness<span class="metric-ref">CHAOSS: Elephant Factor / Bus Factor</span></th>
                    <td><b>CAF 10+</b>ï¼šä¸»è¦ãªã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’ç¶­æŒã™ã‚‹äººæ•°ã€‚å±äººåŒ–ã«ã‚ˆã‚‹ç¶™ç¶šæ€§ãƒªã‚¹ã‚¯ã‚’è©•ä¾¡ã€‚</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div class="footer-links">
    Learn more about OSS Health Metrics at 
    <a href="https://chaoss.community/" target="_blank">CHAOSS Community Official Site</a>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
    const projectFiles = [
        { id: "linux", name: "Linux Kernel", file: "torvalds_linux_final_report.json" },
        { id: "clickhouse", name: "ClickHouse", file: "ClickHouse_ClickHouse_final_report.json" },
        { id: "postgres", name: "PostgreSQL", file: "postgres_postgres_final_report.json" },
        { id: "tsurugi", name: "TsurugiDB", file: "project-tsurugi_tsurugidb_final_report.json" }
    ];

    const width = 750, height = 600, margin = 110;
    const radius = Math.min(width, height) / 2 - margin;
    const axes = ["Activity", "Diversity", "Density", "Responsiveness", "Robustness"];
    const angleSlice = (Math.PI * 2) / axes.length;
    const colors = d3.scaleOrdinal().range(["#ef4444", "#3b82f6", "#f59e0b", "#10b981", "#8b5cf6"]);

    let loadedRawData = {};
    const tooltip = d3.select("#tooltip");

    function getScoresByYear(data, year) {
        const d = data.metrics[year];
        if (!d || parseInt(year) > 2025) return null;
        
        return [
            { axis: "Activity",       value: Math.min(5, d.total_commits / 1000), raw: `${d.total_commits.toLocaleString()} commits` },
            { axis: "Diversity",      value: Math.min(5, (d.org_count / 15) + (d.elephant_factor > 1 ? 2 : 0)), raw: `${d.org_count} Orgs` },
            { axis: "Density",        value: Math.min(5, (d.contrib_active_n10 / (d.contrib_total || 1)) * 7.1), raw: `${Math.round((d.contrib_active_n10/(d.contrib_total||1))*100)}% Active` },
            { axis: "Responsiveness", value: Math.max(0.2, Math.min(5, 5 - (d.avg_days_to_close / 14))), raw: `${d.avg_days_to_close.toFixed(1)} days avg` },
            { axis: "Robustness",     value: Math.min(5, d.bus_factor_caf / 2), raw: `Bus Factor: ${d.bus_factor_caf}` }
        ];
    }

    async function init() {
        let allYears = new Set();
        for (const p of projectFiles) {
            try {
                const res = await fetch(`./output/${p.file}`);
                const json = await res.json();
                loadedRawData[p.id] = json;
                Object.keys(json.metrics).forEach(y => { if(parseInt(y) <= 2025) allYears.add(y); });
            } catch (e) { console.error("Skip:", p.file); }
        }

        const yearList = Array.from(allYears).sort();
        const slider = document.getElementById("year-slider");
        slider.min = yearList[0]; slider.max = yearList[yearList.length - 1]; slider.value = slider.max;
        document.getElementById("current-year-display").innerText = slider.value;

        slider.oninput = function() {
            document.getElementById("current-year-display").innerText = this.value;
            updateChart();
        };

        const selectors = d3.select("#selectors");
        projectFiles.forEach((p, i) => {
            const div = selectors.append("div").attr("class", "project-selector").style("border-left-color", colors(i));
            div.append("input").attr("type", "checkbox").attr("id", p.id).attr("checked", true).on("change", updateChart);
            div.append("label").attr("for", p.id).text(p.name);
        });

        updateChart();
    }

    function updateChart() {
        d3.select("#chart").selectAll("*").remove();
        const targetYear = document.getElementById("year-slider").value;
        const activeIds = projectFiles.filter(p => document.getElementById(p.id).checked).map(p => p.id);
        
        const svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height)
                      .append("g").attr("transform", `translate(${width/2},${height/2})`);

        [1, 2, 3, 4, 5].forEach(l => {
            const r = (radius / 5) * l;
            svg.append("circle").attr("r", r).attr("fill", "none").attr("stroke", "#e2e8f0").attr("stroke-width", 1.5);
            svg.append("text").attr("y", -r - 5).attr("x", 5).text(l).style("font-size", "10px").attr("fill", "#cbd5e1");
        });

        axes.forEach((axis, i) => {
            const x = radius * Math.cos(angleSlice * i - Math.PI/2);
            const y = radius * Math.sin(angleSlice * i - Math.PI/2);
            svg.append("line").attr("x1", 0).attr("y1", 0).attr("x2", x).attr("y2", y).attr("stroke", "#cbd5e1");
            svg.append("text").attr("x", x * 1.25).attr("y", y * 1.15).attr("text-anchor", "middle").attr("class", "axis-label").text(axis);
        });

        const radarLine = d3.lineRadial().radius(d => (d.value / 5) * radius).angle((d, i) => i * angleSlice).curve(d3.curveLinearClosed);

        activeIds.forEach(id => {
            const raw = loadedRawData[id];
            const scores = getScoresByYear(raw, targetYear);
            if (!scores) return;

            const color = colors(projectFiles.findIndex(p => p.id === id));
            svg.append("path").datum(scores).attr("d", radarLine).attr("class", "radar-area").attr("fill", color).attr("stroke", color);

            scores.forEach((s, j) => {
                const cx = (s.value/5) * radius * Math.cos(angleSlice * j - Math.PI/2);
                const cy = (s.value/5) * radius * Math.sin(angleSlice * j - Math.PI/2);
                svg.append("circle").attr("r", 6).attr("cx", cx).attr("cy", cy).attr("fill", color)
                   .on("mouseover", (e) => {
                       tooltip.style("opacity", 1).html(`<strong>${raw.project}</strong><br>âœ¨ ${s.axis}: Lv ${s.value.toFixed(1)}<br>ğŸ“Š ${s.raw}`);
                   })
                   .on("mousemove", (e) => tooltip.style("left", (e.clientX + 15) + "px").style("top", (e.clientY - 20) + "px"))
                   .on("mouseleave", () => tooltip.style("opacity", 0));
            });
        });
    }
    init();
</script>
</body>
</html>