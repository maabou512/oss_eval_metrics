<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OSS Health Radar - Professional Edition</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f4f7f9; --card: #ffffff; --text: #334155; --chaoss: #002d4b; --lv5-blue: #3b82f6; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .dashboard { display: grid; grid-template-columns: 320px 1fr; gap: 24px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--card); padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); }
        
        /* Sidebar */
        .timeline-ctrl { margin: 16px 0 24px; padding: 20px; background: #f8fafc; border-radius: 12px; text-align: center; }
        #year-slider { width: 100%; margin-top: 12px; cursor: pointer; }
        #current-year-display { font-size: 36px; font-weight: 800; color: var(--primary); }
        .project-selector { margin-bottom: 10px; padding: 12px; border-radius: 10px; border: 1px solid #f1f5f9; display: flex; align-items: center; cursor: pointer; font-weight: 600; border-left: 6px solid #ccc; transition: 0.2s; }
        .project-selector:hover { background: #f1f5f9; }

        /* Main Chart */
        #chart-container { display: flex; flex-direction: column; align-items: center; }
        .tooltip { position: fixed; padding: 12px 16px; background: rgba(15, 23, 42, 0.95); color: #fff; border-radius: 8px; font-size: 13px; pointer-events: none; opacity: 0; z-index: 9999; box-shadow: 0 10px 15px rgba(0,0,0,0.2); line-height: 1.6; }

        /* Metric Table */
        #explanation { width: 100%; margin-top: 32px; padding-top: 24px; border-top: 2px solid #f1f5f9; }
        .info-table { width: 100%; border-collapse: collapse; margin-top: 16px; background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid #eef2f6; }
        .info-table th, .info-table td { padding: 18px 24px; text-align: left; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .info-table th { background: #f8fafc; width: 240px; vertical-align: top; border-right: 1px solid #f1f5f9; }
        
        .metric-title { font-weight: 800; font-size: 16px; color: var(--text); display: block; margin-bottom: 4px; }
        .metric-sub { font-size: 11px; color: #94a3b8; font-weight: normal; }
        .lv5-def { color: var(--lv5-blue); font-weight: 700; }
        .formula-box { display: block; background: #f8fafc; padding: 6px 10px; border-radius: 6px; border: 1px solid #eef2f6; font-family: "Courier New", monospace; margin: 8px 0; color: #475569; font-size: 12px; }

        .axis-label { font-size: 14px; font-weight: 800; fill: #475569; }
        .radar-area { fill-opacity: 0.15; stroke-width: 4; }
    </style>
</head>
<body>

<div class="dashboard">
    <div id="sidebar" class="card">
        <h3 style="margin-top:0">ğŸ“… Timeline</h3>
        <div class="timeline-ctrl">
            <span id="current-year-display">----</span>
            <input type="range" id="year-slider" step="1">
        </div>
        <h3 style="margin-bottom:16px">ğŸš€ Projects</h3>
        <div id="selectors"></div>
    </div>

    <div id="chart-container" class="card">
        <h2 style="margin: 0;">OSS Health Radar Comparison</h2>
        <p style="margin: 5px 0 25px 0; color: #64748b;">Powered by CHAOSS Metrics Framework</p>
        <div id="chart"></div>
        
        <div id="explanation">
            <h4 style="margin:0; color: var(--chaoss);">ğŸ“Š æŒ‡æ¨™ã®å®šç¾©ã¨Lv.5ï¼ˆæœ€å¤§å€¤ï¼‰ã®åŸºæº–</h4>
            <table class="info-table">
                <tr>
                    <th>
                        <span class="metric-title">Activity</span>
                        <span class="metric-sub">CHAOSS: Code Changes / Commits</span>
                    </th>
                    <td>
                        <span class="lv5-def">å¹´é–“ 5,000 commitsã€œ</span> ï¼šé–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰ãŒéå¸¸ã«é€Ÿãã€æ©Ÿèƒ½è¿½åŠ ã‚„æ”¹å–„ãŒæ¥µã‚ã¦æ´»ç™ºãªçŠ¶æ…‹ã€‚<br>
                        <span class="formula-box">ç®—å‡ºå¼: (å¹´é–“ã‚³ãƒŸãƒƒãƒˆæ•° / 1,000) [å˜ä½: Lv]</span>
                    </td>
                </tr>
                <tr>
                    <th>
                        <span class="metric-title">Diversity</span>
                        <span class="metric-sub">CHAOSS: Organizational Diversity</span>
                    </th>
                    <td>
                        <span class="lv5-def">æ‰€å± 15çµ„ç¹”ä»¥ä¸Š</span> ï¼šç‰¹å®šã®1ç¤¾ã«ä¾å­˜ã›ãšã€å¤šæ§˜ãªä¼æ¥­ãƒ»å›£ä½“ãŒé–‹ç™ºã‚’æ”¯ãˆã‚‹å¼·å›ºãªã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã€‚<br>
                        <span class="formula-box">ç®—å‡ºå¼: (æ‰€å±çµ„ç¹”æ•° / 15) + (Elephant Factorè£œæ­£) [å˜ä½: çµ„ç¹”æ•°]</span>
                    </td>
                </tr>
                <tr>
                    <th>
                        <span class="metric-title">Density</span>
                        <span class="metric-sub">CHAOSS: Active Contributors</span>
                    </th>
                    <td>
                        <span class="lv5-def">Activeç‡ 70%ã€œ</span> ï¼šè²¢çŒ®è€…ã®å¤šããŒã€Œå¸¸é€£ï¼ˆå¹´é–“10å›ä»¥ä¸Šï¼‰ã€ã§ã‚ã‚Šã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ç†±é‡ãŒé«˜ã„ã€‚<br>
                        <span class="formula-box">ç®—å‡ºå¼: (Activeè²¢çŒ®è€…æ•° / å…¨è²¢çŒ®è€…æ•°) Ã— 100 [å˜ä½: ï¼…]</span>
                    </td>
                </tr>
                <tr>
                    <th>
                        <span class="metric-title">Responsiveness</span>
                        <span class="metric-sub">CHAOSS: Time to Close</span>
                    </th>
                    <td>
                        <span class="lv5-def">å¹³å‡ 5æ—¥ä»¥å†…</span> ï¼šIssueã‚„PRã¸ã®åå¿œãŒé€Ÿãã€å¤–éƒ¨ã‹ã‚‰ã®è²¢çŒ®ã‚’å—ã‘å…¥ã‚Œã‚„ã™ã„ã‚ªãƒ¼ãƒ—ãƒ³ãªä½“åˆ¶ã€‚<br>
                        <span class="formula-box">ç®—å‡ºå¼: 5 - (ã‚¯ãƒ­ãƒ¼ã‚ºã¾ã§ã®å¹³å‡æ—¥æ•° / 14) [å˜ä½: æ—¥]</span>
                    </td>
                </tr>
                <tr>
                    <th>
                        <span class="metric-title">Robustness</span>
                        <span class="metric-sub">CHAOSS: Elephant Factor / Bus Factor</span>
                    </th>
                    <td>
                        <span class="lv5-def">CAF 10äººä»¥ä¸Š</span> ï¼šä¸»è¦é–‹ç™ºè€…ãŒå¤šãã€ç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼ãŒé›¢è„±ã—ã¦ã‚‚ç¶™ç¶šå¯èƒ½ãªå …ç‰¢æ€§ã€‚<br>
                        <span class="formula-box">ç®—å‡ºå¼: (Code Authorship Factor) [å˜ä½: äººæ•°]</span>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
    const projectFiles = [
        {
                "id": "ClickHouse_ClickHouse",
                "name": "Clickhouse",
                "file": "output/ClickHouse_ClickHouse_final_report.json"
        },
        {
                "id": "mongodb_mongo",
                "name": "Mongodb",
                "file": "output/mongodb_mongo_final_report.json"
        },
        {
                "id": "postgres_postgres",
                "name": "Postgres",
                "file": "output/postgres_postgres_final_report.json"
        },
        {
                "id": "project-tsurugi_tsurugidb",
                "name": "Project-tsurugi",
                "file": "output/project-tsurugi_tsurugidb_final_report.json"
        },
        {
                "id": "torvalds_linux",
                "name": "Torvalds",
                "file": "output/torvalds_linux_final_report.json"
        }
]; // sync_dashboard.py ã§è‡ªå‹•æŒ¿å…¥

    const width = 750, height = 600, margin = 110;
    const radius = Math.min(width, height) / 2 - margin;
    const axes = ["Activity", "Diversity", "Density", "Responsiveness", "Robustness"];
    const angleSlice = (Math.PI * 2) / axes.length;
    const colors = d3.scaleOrdinal().range(["#ef4444", "#3b82f6", "#f59e0b", "#10b981", "#8b5cf6", "#6366f1", "#ec4899"]);

    let loadedRawData = {};
    const tooltip = d3.select("#tooltip");

    function getScoresByYear(data, year) {
        const d = data.metrics[year];
        if (!d) return null;
        
        const activeRatio = (d.contrib_active_n10 / (d.contrib_total || 1));

        return [
            { axis: "Activity",       value: Math.min(5, d.total_commits / 1000), raw: `${d.total_commits.toLocaleString()} commits` },
            { axis: "Diversity",      value: Math.min(5, (d.org_count / 15) + (d.elephant_factor > 1 ? 2 : 0)), raw: `${d.org_count} Orgs` },
            { axis: "Density",        value: Math.min(5, activeRatio * 7.1), raw: `${Math.round(activeRatio * 100)}% Active` },
            { axis: "Responsiveness", value: Math.max(0.2, Math.min(5, 5 - (d.avg_days_to_close / 14))), raw: `${d.avg_days_to_close.toFixed(1)} days avg` },
            { axis: "Robustness",     value: Math.min(5, d.bus_factor_caf / 2), raw: `CAF: ${d.bus_factor_caf}` }
        ];
    }

    async function init() {
        if (projectFiles.length === 0) return;
        let allYears = new Set();
        for (const p of projectFiles) {
            try {
                const res = await fetch(p.file); 
                const json = await res.json();
                loadedRawData[p.id] = json;
                Object.keys(json.metrics).forEach(y => { if(parseInt(y) <= 2025) allYears.add(y); });
            } catch (e) { console.error(e); }
        }
        const yearList = Array.from(allYears).sort();
        const slider = document.getElementById("year-slider");
        slider.min = yearList[0]; slider.max = yearList[yearList.length - 1]; slider.value = slider.max;
        document.getElementById("current-year-display").innerText = slider.value;
        slider.oninput = function() { document.getElementById("current-year-display").innerText = this.value; updateChart(); };

        const selectors = d3.select("#selectors");
        projectFiles.forEach((p, i) => {
            const div = selectors.append("div").attr("class", "project-selector").style("border-left-color", colors(i));
            div.append("input").attr("type", "checkbox").attr("id", p.id).attr("checked", true).on("change", updateChart);
            div.append("label").attr("for", p.id).text(p.name);
        });
        updateChart();
    }

    function updateChart() {
        d3.select("#chart").selectAll("*").remove();
        const targetYear = document.getElementById("year-slider").value;
        const activeIds = projectFiles.filter(p => document.getElementById(p.id).checked).map(p => p.id);
        const svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height).append("g").attr("transform", `translate(${width/2},${height/2})`);

        [1, 2, 3, 4, 5].forEach(l => {
            const r = (radius / 5) * l;
            svg.append("circle").attr("r", r).attr("fill", "none").attr("stroke", "#e2e8f0").attr("stroke-width", 1.5);
            svg.append("text").attr("y", -r - 5).attr("x", 5).text(l).style("font-size", "10px").attr("fill", "#cbd5e1");
        });

        axes.forEach((axis, i) => {
            const x = radius * Math.cos(angleSlice * i - Math.PI/2);
            const y = radius * Math.sin(angleSlice * i - Math.PI/2);
            svg.append("line").attr("x1", 0).attr("y1", 0).attr("x2", x).attr("y2", y).attr("stroke", "#cbd5e1");
            svg.append("text").attr("x", x * 1.3).attr("y", y * 1.15).attr("text-anchor", "middle").attr("class", "axis-label").text(axis);
        });

        const radarLine = d3.lineRadial().radius(d => (d.value / 5) * radius).angle((d, i) => i * angleSlice).curve(d3.curveLinearClosed);

        activeIds.forEach(id => {
            const raw = loadedRawData[id];
            const scores = getScoresByYear(raw, targetYear);
            if (!scores) return;
            const color = colors(projectFiles.findIndex(p => p.id === id));
            svg.append("path").datum(scores).attr("d", radarLine).attr("class", "radar-area").attr("fill", color).attr("stroke", color);
            scores.forEach((s, j) => {
                const cx = (s.value/5) * radius * Math.cos(angleSlice * j - Math.PI/2);
                const cy = (s.value/5) * radius * Math.sin(angleSlice * j - Math.PI/2);
                svg.append("circle").attr("r", 5).attr("cx", cx).attr("cy", cy).attr("fill", color)
                   .on("mouseover", (e) => { tooltip.style("opacity", 1).html(`<strong>${raw.project}</strong><br>âœ¨ ${s.axis}: Lv ${s.value.toFixed(1)}<br>ğŸ“Š ${s.raw}`); })
                   .on("mousemove", (e) => tooltip.style("left", (e.clientX + 15) + "px").style("top", (e.clientY - 20) + "px"))
                   .on("mouseleave", () => tooltip.style("opacity", 0));
            });
        });
    }
    init();
</script>
</body>
</html>