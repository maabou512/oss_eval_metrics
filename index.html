<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OSS Health Radar Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f4f7f9; margin: 0; padding: 20px; color: #333; }
        .dashboard { display: grid; grid-template-columns: 320px 1fr; gap: 20px; max-width: 1400px; margin: 0 auto; }
        
        #sidebar { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: fit-content; }
        #chart-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .project-selector { margin-bottom: 12px; padding: 12px; border-radius: 8px; border: 1px solid #eee; transition: 0.2s; display: flex; align-items: center; }
        .project-selector:hover { background: #f9f9f9; }
        .project-selector input { margin-right: 12px; transform: scale(1.2); cursor: pointer; }
        .project-selector label { cursor: pointer; font-weight: bold; flex-grow: 1; }
        
        #explanation { margin-top: 40px; padding: 25px; background: #fafafa; border-radius: 12px; border-top: 4px solid #007bff; }
        #explanation h4 { margin-top: 0; color: #007bff; font-size: 18px; }
        #explanation p { font-size: 14px; color: #666; margin-bottom: 20px; }
        #explanation table { width: 100%; border-collapse: collapse; font-size: 14px; background: white; border-radius: 8px; overflow: hidden; }
        #explanation th, #explanation td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #eee; }
        #explanation th { background: #f0f4f8; color: #444; }

        .axis-label { font-size: 14px; font-weight: bold; fill: #555; }
        .radar-area { fill-opacity: 0.2; stroke-width: 3; }
    </style>
</head>
<body>

<h2 style="text-align: center; margin-bottom: 30px;">ğŸš€ OSS Health Radar Comparison</h2>

<div class="dashboard">
    <div id="sidebar">
        <h3 style="margin-top:0">Select Projects</h3>
        <div id="selectors"></div>
        <p style="font-size: 12px; color: #999; margin-top: 25px; line-height: 1.4;">
            å·¦å´ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§æ¯”è¼ƒå¯¾è±¡ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ <code>output/</code> å†…ã®å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœ€æ–°å¹´åº¦ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚
        </p>
    </div>

    <div id="chart-container">
        <div id="chart" style="display: flex; justify-content: center;"></div>
        
        <div id="explanation">
            <h4>ğŸ“Š æŒ‡æ¨™ã®å®šç¾©ã¨ç‰¹æ€§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</h4>
            <p>ã“ã®ãƒãƒ£ãƒ¼ãƒˆã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å„ªåŠ£ã‚’ã€Œæ¡ç‚¹ã€ã™ã‚‹ã‚‚ã®ã§ã¯ãªãã€å„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®æ§‹é€ çš„ç‰¹å¾´ã‚„ãƒªã‚½ãƒ¼ã‚¹ã®é›†ä¸­åº¦ã‚’å¯è¦–åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚å¤–å´ã«åºƒãŒã‚‹ã»ã©ã€ãã®é …ç›®ã«ãŠã‘ã‚‹ç‰¹æ€§ãŒå¼·ã„ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚</p>
            <table>
                <thead>
                    <tr><th>æŒ‡æ¨™</th><th>ãƒ¬ãƒ™ãƒ«5 (å¤–é™) ã®ç›®å®‰</th><th>ç‰¹æ€§ã®è§£èª¬</th></tr>
                </thead>
                <tbody>
                    <tr><td><b>Activity</b></td><td>å¹´é–“ 5,000 ã‚³ãƒŸãƒƒãƒˆã€œ</td><td>é–‹ç™ºã®å›è»¢é€Ÿåº¦ã€‚éå¸¸ã«æ´»ç™ºãªæ©Ÿèƒ½è¿½åŠ ãƒ»æ”¹å–„ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã€‚</td></tr>
                    <tr><td><b>Diversity</b></td><td>é–¢ä¸çµ„ç¹” 15ä»¥ä¸Š (Elephant 2ä»¥ä¸Š)</td><td>çµ„ç¹”ã®å¤šæ§˜æ€§ã€‚è¤‡æ•°ã®ä¼æ¥­ã‚„å›£ä½“ãŒæ”¯ãˆåˆã„ã€è‡ªç«‹ã—ãŸã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‚’å½¢æˆã€‚</td></tr>
                    <tr><td><b>Density</b></td><td>Activeè²¢çŒ®è€…ç‡ 70%ã€œ</td><td>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®å¯†åº¦ã€‚ä¸€è¦‹ã•ã‚“ã§ã¯ãªãã€ç¶™ç¶šçš„ãªå¸¸é€£ãŒä¸»ä½“ã¨ãªã£ã¦é–‹ç™ºã€‚</td></tr>
                    <tr><td><b>Responsiveness</b></td><td>å¹³å‡ã‚¯ãƒ­ãƒ¼ã‚º 5æ—¥ä»¥å†…</td><td>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®é€Ÿã•ã€‚Issueã‚„PRãŒç´ æ—©ãå‡¦ç†ã•ã‚Œã€è²¢çŒ®ã®éšœå£ãŒä½ã„ã€‚</td></tr>
                    <tr><td><b>Robustness</b></td><td>Bus Factor (CAF) 10ä»¥ä¸Š</td><td>å±¤ã®åšã•ã€‚ç‰¹å®šã®å°‘äººæ•°ã«ä¾å­˜ã›ãšã€çŸ¥è¦‹ãŒãƒãƒ¼ãƒ å†…ã«åˆ†æ•£ã•ã‚Œã¦ã„ã‚‹ã€‚</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š ---
    const projectFiles = [
        { id: "clickhouse", name: "ClickHouse", file: "ClickHouse_ClickHouse_final_report.json" },
        { id: "postgres", name: "PostgreSQL", file: "postgres_postgres_final_report.json" },
        { id: "tsurugi", name: "TsurugiDB", file: "project-tsurugi_tsurugidb_final_report.json" }
    ];

    const width = 600, height = 500, margin = 75;
    const radius = Math.min(width, height) / 2 - margin;
    const axes = ["Activity", "Diversity", "Density", "Responsiveness", "Robustness"];
    const angleSlice = (Math.PI * 2) / axes.length;
    const colors = d3.scaleOrdinal(d3.schemeCategory10);

    let loadedData = {};

    // --- å„æŒ‡æ¨™ã®æ­£è¦åŒ–ãƒ­ã‚¸ãƒƒã‚¯ ---
    function getScores(data) {
        const years = Object.keys(data.metrics).sort();
        const d = data.metrics[years[years.length - 1]]; // æœ€æ–°å¹´
        
        return [
            {axis: "Activity",       value: Math.min(5, d.total_commits / 1000)}, // 5000ã§Lv5
            {axis: "Diversity",      value: Math.min(5, (d.org_count / 15) + (d.elephant_factor > 1 ? 2 : 0))},
            {axis: "Density",        value: Math.min(5, (d.contrib_active_n10 / d.contrib_total) * 7.1)}, // 70%ã§Lv5
            {axis: "Responsiveness", value: Math.max(0.5, Math.min(5, 5 - (d.avg_days_to_close / 14)))}, // 2é€±é–“ç¨‹åº¦ãªã‚‰ä¸­é–“
            {axis: "Robustness",     value: Math.min(5, d.bus_factor_caf / 2)} // CAF 10ã§Lv5
        ];
    }

    // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®æ§‹ç¯‰
    const selectors = d3.select("#selectors");
    projectFiles.forEach((p, i) => {
        const div = selectors.append("div").attr("class", "project-selector");
        div.append("input")
            .attr("type", "checkbox")
            .attr("id", p.id)
            .on("change", () => updateChart());
        div.append("label")
            .attr("for", p.id)
            .style("color", colors(i))
            .text(p.name);
    });

    // åˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    async function init() {
        for (const p of projectFiles) {
            try {
                const res = await fetch(`./output/${p.file}`);
                const json = await res.json();
                loadedData[p.id] = { 
                    name: p.name, 
                    scores: getScores(json), 
                    color: colors(projectFiles.indexOf(p)) 
                };
            } catch (e) { 
                console.error("Error loading file:", p.file); 
            }
        }
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå…¨é¸æŠ
        projectFiles.forEach(p => { if(document.getElementById(p.id)) document.getElementById(p.id).checked = true; });
        updateChart();
    }

    function updateChart() {
        d3.select("#chart").selectAll("*").remove();
        const activeIds = projectFiles.filter(p => document.getElementById(p.id).checked).map(p => p.id);
        
        const svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height)
                      .append("g").attr("transform", `translate(${width/2},${height/2})`);

        // åŒå¿ƒå††ã‚¬ã‚¤ãƒ‰
        [1, 2, 3, 4, 5].forEach(l => {
            const r = (radius / 5) * l;
            svg.append("circle").attr("r", r).attr("fill", "none").attr("stroke", "#eee");
            svg.append("text").attr("y", -r - 5).attr("x", 5).text(l).style("font-size", "10px").attr("fill", "#ccc");
        });

        // ã‚¹ãƒãƒ¼ã‚¯ï¼ˆè»¸ï¼‰
        axes.forEach((axis, i) => {
            const x = radius * Math.cos(angleSlice * i - Math.PI/2);
            const y = radius * Math.sin(angleSlice * i - Math.PI/2);
            svg.append("line").attr("x1", 0).attr("y1", 0).attr("x2", x).attr("y2", y).attr("stroke", "#ddd");
            svg.append("text").attr("x", x * 1.22).attr("y", y * 1.15).attr("text-anchor", "middle").attr("class", "axis-label").text(axis);
        });

        const radarLine = d3.lineRadial()
            .radius(d => (d.value / 5) * radius)
            .angle((d, i) => i * angleSlice)
            .curve(d3.curveLinearClosed);

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®ãƒãƒªã‚´ãƒ³
        activeIds.forEach(id => {
            const p = loadedData[id];
            if (!p) return;
            svg.append("path")
                .datum(p.scores)
                .attr("d", radarLine)
                .attr("class", "radar-area")
                .attr("fill", p.color)
                .attr("stroke", p.color);

            p.scores.forEach((s, j) => {
                svg.append("circle")
                   .attr("r", 4)
                   .attr("fill", p.color)
                   .attr("cx", (s.value/5) * radius * Math.cos(angleSlice * j - Math.PI/2))
                   .attr("cy", (s.value/5) * radius * Math.sin(angleSlice * j - Math.PI/2));
            });
        });
    }

    init();
</script>
</body>
</html>