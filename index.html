<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OSS Health Radar - Large Display</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f4f7f9; --card: #ffffff; --text: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .dashboard { display: grid; grid-template-columns: 320px 1fr; gap: 24px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--card); padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .timeline-ctrl { margin: 16px 0 24px; padding: 20px; background: #f8fafc; border-radius: 12px; text-align: center; }
        #year-slider { width: 100%; margin-top: 12px; cursor: pointer; }
        #current-year-display { font-size: 36px; font-weight: 800; color: var(--primary); }

        .project-selector { margin-bottom: 10px; padding: 12px; border-radius: 10px; border: 1px solid #f1f5f9; display: flex; align-items: center; cursor: pointer; font-weight: 600; }
        .project-selector input { margin-right: 12px; width: 18px; height: 18px; }

        /* ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ï¼ˆå¤§ããç¢ºä¿ï¼‰ */
        #chart-container { display: flex; flex-direction: column; align-items: center; overflow: visible; }
        #chart { width: 100%; display: flex; justify-content: center; overflow: visible; }

        .tooltip {
            position: fixed; padding: 12px 16px; background: rgba(15, 23, 42, 0.95); color: #fff;
            border-radius: 8px; font-size: 13px; pointer-events: none; opacity: 0; z-index: 9999;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); line-height: 1.6;
        }

        /* æŒ‡æ¨™ãƒªã‚¹ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ */
        #explanation { width: 100%; margin-top: 32px; border-top: 2px solid #f1f5f9; padding-top: 20px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
        .info-item { padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid var(--primary); }
        .info-label { font-weight: 800; font-size: 14px; margin-bottom: 4px; }
        .info-desc { font-size: 12px; color: #64748b; }

        .axis-label { font-size: 16px; font-weight: 800; fill: #475569; }
        .radar-area { fill-opacity: 0.15; stroke-width: 4; transition: 0.3s; }
    </style>
</head>
<body>

<div class="dashboard">
    <div id="sidebar" class="card">
        <h3 style="margin-top:0">ğŸ“… Timeline</h3>
        <div class="timeline-ctrl">
            <span id="current-year-display">----</span>
            <input type="range" id="year-slider" step="1">
        </div>
        <h3 style="margin-bottom:16px">ğŸš€ Projects</h3>
        <div id="selectors"></div>
    </div>

    <div id="chart-container" class="card">
        <h2 style="margin-bottom: 30px;">OSS Health Radar Comparison</h2>
        <div id="chart"></div>
        
        <div id="explanation">
            <h4 style="margin-bottom:16px;">ğŸ“Œ æŒ‡æ¨™ã®å®šç¾©</h4>
            <div class="info-grid">
                <div class="info-item"><div class="info-label">Activity</div><div class="info-desc">é–‹ç™ºã®å›è»¢é€Ÿåº¦ã€‚å¹´é–“5,000ã‚³ãƒŸãƒƒãƒˆä»¥ä¸Šã§æœ€å¤§å¼·åº¦ã€‚</div></div>
                <div class="info-item"><div class="info-label">Diversity</div><div class="info-desc">çµ„ç¹”å¤šæ§˜æ€§ã€‚15çµ„ç¹”ä»¥ä¸Šã§æœ€å¤§ã€‚ç‰¹å®šä¼æ¥­ã¸ã®ä¾å­˜åº¦ã€‚</div></div>
                <div class="info-item"><div class="info-label">Density</div><div class="info-desc">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å¯†åº¦ã€‚å¸¸é€£è²¢çŒ®è€…ãŒ70%è¶…ã§æœ€å¤§ã€‚å±¤ã®åšã•ã€‚</div></div>
                <div class="info-item"><div class="info-label">Responsiveness</div><div class="info-desc">å¹³å‡ã‚¯ãƒ­ãƒ¼ã‚ºæ—¥æ•°ã€‚5æ—¥ä»¥å†…ãªã‚‰æœ€å¤§ã€‚å¯¾å¿œã®é€Ÿã•ã€‚</div></div>
                <div class="info-item"><div class="info-label">Robustness</div><div class="info-desc">Bus Factor (CAF)ã€‚10åä»¥ä¸Šã§æœ€å¤§ã€‚å±äººåŒ–ãƒªã‚¹ã‚¯ã€‚</div></div>
            </div>
        </div>
    </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
    const projectFiles = [
        { id: "clickhouse", name: "ClickHouse", file: "ClickHouse_ClickHouse_final_report.json" },
        { id: "postgres", name: "PostgreSQL", file: "postgres_postgres_final_report.json" },
        { id: "tsurugi", name: "TsurugiDB", file: "project-tsurugi_tsurugidb_final_report.json" }
    ];

    // --- ã‚µã‚¤ã‚ºã‚’å¤§å¹…ã«ã‚¢ãƒƒãƒ— ---
    const width = 800, height = 650;
    const margin = 100; // ãƒ©ãƒ™ãƒ«ã®ãŸã‚ã«ä½™ç™½ã‚’åºƒã‚ã«ç¢ºä¿
    const radius = Math.min(width, height) / 2 - margin;
    const axes = ["Activity", "Diversity", "Density", "Responsiveness", "Robustness"];
    const angleSlice = (Math.PI * 2) / axes.length;
    const colors = d3.scaleOrdinal().range(["#3b82f6", "#f59e0b", "#10b981", "#8b5cf6", "#ef4444"]);

    let loadedRawData = {};
    const tooltip = d3.select("#tooltip");

    function getScoresByYear(data, year) {
        const d = data.metrics[year];
        if (!d) return null;
        return [
            { axis: "Activity",       value: Math.min(5, d.total_commits / 1000), raw: `${d.total_commits} commits` },
            { axis: "Diversity",      value: Math.min(5, (d.org_count / 15) + (d.elephant_factor > 1 ? 2 : 0)), raw: `${d.org_count} Orgs` },
            { axis: "Density",        value: Math.min(5, (d.contrib_active_n10 / (d.contrib_total || 1)) * 7.1), raw: `${Math.round((d.contrib_active_n10/d.contrib_total)*100)}% Active` },
            { axis: "Responsiveness", value: Math.max(0.5, Math.min(5, 5 - (d.avg_days_to_close / 14))), raw: `${d.avg_days_to_close.toFixed(1)} days` },
            { axis: "Robustness",     value: Math.min(5, d.bus_factor_caf / 2), raw: `Bus Factor: ${d.bus_factor_caf}` }
        ];
    }

    async function init() {
        let allYears = new Set();
        for (const p of projectFiles) {
            try {
                const res = await fetch(`./output/${p.file}`);
                const json = await res.json();
                loadedRawData[p.id] = json;
                Object.keys(json.metrics).forEach(y => allYears.add(y));
            } catch (e) { console.error("Error:", p.file); }
        }

        const yearList = Array.from(allYears).sort();
        const slider = document.getElementById("year-slider");
        slider.min = yearList[0]; slider.max = yearList[yearList.length - 1]; slider.value = slider.max;
        document.getElementById("current-year-display").innerText = slider.value;

        slider.oninput = function() { document.getElementById("current-year-display").innerText = this.value; updateChart(); };

        const selectors = d3.select("#selectors");
        projectFiles.forEach((p, i) => {
            const div = selectors.append("div").attr("class", "project-selector").style("border-left", `6px solid ${colors(i)}`);
            div.append("input").attr("type", "checkbox").attr("id", p.id).attr("checked", true).on("change", updateChart);
            div.append("label").attr("for", p.id).text(p.name);
        });

        updateChart();
    }

    function updateChart() {
        d3.select("#chart").selectAll("*").remove();
        const targetYear = document.getElementById("year-slider").value;
        const activeIds = projectFiles.filter(p => document.getElementById(p.id).checked).map(p => p.id);
        
        const svg = d3.select("#chart").append("svg")
                      .attr("width", width).attr("height", height)
                      .attr("viewBox", `0 0 ${width} ${height}`)
                      .append("g").attr("transform", `translate(${width/2},${height/2})`);

        // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ï¼ˆLv.5ã¾ã§ï¼‰
        [1, 2, 3, 4, 5].forEach(l => {
            const r = (radius / 5) * l;
            svg.append("circle").attr("r", r).attr("fill", "none").attr("stroke", "#e2e8f0").attr("stroke-width", 1.5);
        });

        // è»¸ã¨ãƒ©ãƒ™ãƒ«ï¼ˆãƒãƒ¼ã‚¸ãƒ³ã‚’è€ƒæ…®ã—ã¦é…ç½®ï¼‰
        axes.forEach((axis, i) => {
            const x = radius * Math.cos(angleSlice * i - Math.PI/2);
            const y = radius * Math.sin(angleSlice * i - Math.PI/2);
            svg.append("line").attr("x1", 0).attr("y1", 0).attr("x2", x).attr("y2", y).attr("stroke", "#cbd5e1").attr("stroke-width", 2);
            
            // ãƒ©ãƒ™ãƒ«ã®ä½ç½®èª¿æ•´
            const labelX = (radius + 40) * Math.cos(angleSlice * i - Math.PI/2);
            const labelY = (radius + 30) * Math.sin(angleSlice * i - Math.PI/2);
            svg.append("text").attr("x", labelX).attr("y", labelY).attr("text-anchor", "middle").attr("class", "axis-label").text(axis);
        });

        const radarLine = d3.lineRadial().radius(d => (d.value / 5) * radius).angle((d, i) => i * angleSlice).curve(d3.curveLinearClosed);

        activeIds.forEach(id => {
            const raw = loadedRawData[id];
            const scores = getScoresByYear(raw, targetYear);
            if (!scores) return;

            const color = colors(projectFiles.findIndex(p => p.id === id));
            svg.append("path").datum(scores).attr("d", radarLine).attr("class", "radar-area").attr("fill", color).attr("stroke", color);

            scores.forEach((s, j) => {
                const cx = (s.value/5) * radius * Math.cos(angleSlice * j - Math.PI/2);
                const cy = (s.value/5) * radius * Math.sin(angleSlice * j - Math.PI/2);
                svg.append("circle").attr("r", 6).attr("cx", cx).attr("cy", cy).attr("fill", color)
                   .on("mouseover", (e) => {
                       tooltip.style("opacity", 1).html(`<strong>${raw.project}</strong><br>âœ¨ ${s.axis}: Lv ${s.value.toFixed(1)}<br>ğŸ“Š ${s.raw}`);
                   })
                   .on("mousemove", (e) => tooltip.style("left", (e.clientX + 15) + "px").style("top", (e.clientY - 20) + "px"))
                   .on("mouseleave", () => tooltip.style("opacity", 0));
            });
        });
    }
    init();
</script>
</body>
</html>